FROM ubuntu:jammy

ARG DEBIAN_FRONTEND=noninteractive
RUN groupadd -r manticore && useradd -r -g manticore manticore
ENV GOSU_VERSION 1.11


ARG PORTA_IMAGE=quay.io/3scale/porta:latest
ADD debs/*deb packages/
ENV MANTICORE_PKGS="./manticore-converter* ./manticore-common_* ./manticore-server-core* ./manticore-server_* ./manticore-tools* ./manticore-tzdata_*"

RUN set -x \
    && mkdir /etc/ssl/ && touch /usr/bin/manticore-executor \
    && chown -R manticore:manticore /usr/bin/manticore-executor /etc/ssl/ \
    && chmod +x /usr/bin/manticore-executor \
    && apt-get -y update && apt-get -y install --no-install-recommends ca-certificates binutils gdb wget gnupg xz-utils dirmngr locales tzdata cron && rm -rf /var/lib/apt/lists/* \
    && locale-gen --lang en_US \
    && apt-get update && apt-get -y install libexpat1 libodbc1 libpq5 openssl libcurl4 libcrypto++8 libmysqlclient21 mysql-client \
    && apt-get -y purge --auto-remove \
    && rm -f /usr/bin/mariabackup /usr/bin/mysqlslap /usr/bin/mysqladmin /usr/bin/mysqlimport  \
    /usr/bin/mysqlshow /usr/bin/mbstream /usr/bin/mysql_waitpid /usr/bin/innotop /usr/bin/mysqlaccess /usr/bin/mytop  \
    /usr/bin/mysqlreport /usr/bin/mysqldumpslow /usr/bin/mysql_find_rows /usr/bin/mysql_fix_extensions  \
    /usr/bin/mysql_embedded /usr/bin/mysqlcheck

RUN set -x \
    && cd /packages \
    && apt -y install $MANTICORE_PKGS \
    && cd - \
    && mkdir -p /var/run/manticore \
    && mkdir -p /usr/share/doc/manticore-galera \
    && mkdir /docker-entrypoint-initdb.d \
    && apt-get -y purge --auto-remove \
    && rm -rf /var/lib/apt/lists/* \
    && rm -fr /packages \
    && rm -f /usr/bin/spelldump /usr/bin/wordbreaker \
    && mkdir -p /var/run/mysqld/ \
        && chown -R manticore:manticore /docker-entrypoint-initdb.d /var/lib/manticore/ /var/run/mysqld/ /usr/share/manticore/ \
    /usr/share/manticore/modules/ /usr/share/doc/manticore-galera/ /var/run/manticore \
    && echo "\n[mysql]\nsilent\nwait\ntable\n" >> /etc/mysql/my.cnf \
    && mkdir /var/lib/searchd && \
    chmod g+w /var/lib/searchd /var/run/manticore /var/log/manticore && \
    chgrp 0 /var/lib/searchd /var/run/manticore /var/log/manticore

COPY --from=$PORTA_IMAGE /opt/system/config/standalone.sphinx.conf "/etc/manticoresearch/manticore.conf"

RUN touch /etc/cron.d/manticore /var/run/crond.pid && \
    chown manticore:manticore /etc/cron.d/manticore /var/run/crond.pid && \
    sed -i -e 's#/var/run/sphinx/#/var/run/manticore/#' /etc/manticoresearch/manticore.conf && \
    chmod gu+s /usr/sbin/cron

WORKDIR /var/lib/manticore
ENTRYPOINT ["/usr/bin/searchd", "--pidfile", "--config", "/etc/manticoresearch/manticore.conf", "--nodetach"]
EXPOSE 9306/tcp
